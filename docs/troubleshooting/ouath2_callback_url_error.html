<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OAuth2 콜백 URL 매칭 미스터리 해결 기록</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: #f1f5f9;
        }
        .timeline-item { transition: all 0.3s ease; cursor: pointer; }
        .timeline-item.active { background-color: #007bff; color: white; transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .timeline-item.active .timeline-phase { color: white; }
        .timeline-item:not(.active):hover { background-color: #e6f3ff; transform: translateY(-2px); }
        .content-fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .code-block {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            font-size: 0.875rem;
        }
        .text-error { color: #dc3545; }
        .text-warning { color: #ffc107; }
        .text-success { color: #28a745; }
    </style>
</head>
<body class="text-slate-800">

    <main class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-10">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">사건 파일: OAuth2 콜백 필터링 실패 (Final)</h1>
            <p class="mt-2 text-lg text-slate-600">JWT Filter, 세션 문제 해결 후 최종 콜백 패턴 충돌 해결 기록.</p>
        </header>

        <nav id="timeline-nav" class="flex flex-col md:flex-row justify-center items-center gap-2 md:gap-4 mb-12">
            </nav>

        <div id="content-area">
            </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const caseFiles = [
                {
                    phase: "1단계",
                    title: "JWT 필터 위치 조정",
                    icon: "❓",
                    content: {
                        symptom: "OAuth2 콜백 요청이 Spring Security의 `OAuth2LoginAuthenticationFilter`에 도달하지 못하고 <span class='text-error'>No mapping</span> 오류 발생.",
                        hypothesis: "JWT Filter가 너무 앞서서 콜백 URI를 가로채거나, 잘못된 위치에 등록되어 OAuth2 인증 프로세스를 방해했을 것으로 추정.",
                        investigation: [
                            "**JWT 필터 위치 조정:** `@Component`와 `FilterRegistrationBean`을 제거하고, `SecurityConfig` 내에서 <span class='text-success'><strong>.addFilterBefore(jwtFilter, LogoutFilter.class)</strong></span>를 사용하여 JWT 필터를 명확히 설정."
                        ],
                        breakthrough: "필터 순서 자체는 해결되었으나, 콜백 URI가 여전히 매칭되지 않아 문제의 근원이 다른 곳에 있음을 인지."
                    }
                },
                {
                    phase: "2단계",
                    title: "세션 및 Entry Point 처리",
                    icon: "⚔️",
                    content: {
                        symptom: "인증 실패 시 `Access Token is missing...` 메시지와 함께 401 오류가 발생. 또는 세션 설정 문제로 OAuth2 인증 전략 자체가 파괴된 것으로 의심.",
                        hypothesis: "OAuth2LoginAuthenticationFilter가 던진 예외를 JWT 필터의 <span class='text-warning'>CstAuthenticationEntryPoint</span>가 가로채서 잘못된 응답을 내보냈거나, 세션 관련 설정을 건드려 문제가 발생했을 것으로 추정.",
                        investigation: [
                            "**세션 복구:** `@SpringBootApplication`의 `SessionAutoConfiguration` exclude를 제거하고 `NullAuthenticatedSessionStrategy` 관련 코드를 제거하여 OAuth2의 세션 전략 복구.",
                            "**Entry Point 수정:** `CstAuthenticationEntryPoint`에서 콜백 URI 요청이 들어올 경우 <span class='text-success'><strong>throw authException</strong></span> 로직을 사용하여 JWT 핸들러의 오작동을 방지."
                        ],
                        breakthrough: "JWT 필터, 세션, Entry Point의 오작동은 모두 해결되었지만, 로그에 `Did not match request to Ant [pattern='...']` 오류가 지속됨을 확인하고 **패턴 불일치가 핵심**임을 확신."
                    }
                },
                {
                    phase: "3단계",
                    title: "콜백 URI 패턴 불일치",
                    icon: "🔒",
                    content: {
                        symptom: "`redirectionEndpoint`를 <span class='text-error'>.baseUri(\"/oauth2/callback/*\")</span>로 설정했을 때, 실제 요청인 <span class='text-warning'>/oauth2/callback/login/kakao</span>와 매칭되지 않는 오류 발생.",
                        hypothesis: "커스텀 Ant Path <span class='text-error'>*</span> (별 하나)는 경로의 깊이를 모두 처리하지 못하는 문제. 또한 카카오가 보낸 URI에 `/login` 경로가 중복 포함된 것으로 추정.",
                        investigation: [
                            "로그에서 실제 요청 URI에 <span class='text-error'>/login</span> 경로가 중복 포함된 것을 확인.",
                            "Ant Path의 <span class='text-error'>*</span> 패턴은 기본적으로 하나의 경로 세그먼트만 매칭함을 확인.",
                            "이로 인해 커스텀 설정이 무효화되고 Spring의 기본 패턴으로 돌아가려다 충돌 발생."
                        ],
                        breakthrough: "문제의 원인이 **URL 패턴의 깊이 매칭**에 있음을 최종 확인하고, 경로 깊이 매칭을 위한 올바른 Ant Path 구문을 적용하기로 결정."
                    }
                },
                {
                    phase: "4단계",
                    title: "근본적인 해결",
                    icon: "✅",
                    content: {
                        symptom: "모든 JWT/세션/Entry Point 문제를 해결했음에도 콜백 URI 필터링만 실패하는 최종 증상.",
                        hypothesis: "DB 인코딩 문제와 마찬가지로, 이번에도 Spring Security 설정의 **핵심 구문** 오류가 문제일 것으로 추정.",
                        investigation: [
                            "Ant Path에서 모든 하위 경로를 포함하는 문법을 재확인."
                        ],
                        breakthrough: "문제는 Ant Path 설정에 <span class='text-error'>*</span> 대신 <span class='text-success'><strong>**</strong></span>를 사용해야 모든 경로 깊이(`login/kakao` 등)를 포함하여 매칭할 수 있었기 때문임을 최종 확인. `SecurityConfig`의 `redirectionEndpoint` 설정을 <span class='text-success'><strong>.baseUri(\"/oauth2/callback/**\")</strong></span>로 수정하여 Gmail 연동 로직에도 사이드 이펙트 없이 문제 완전히 해결. "
                    }
                }
            ];

            const timelineNav = document.getElementById('timeline-nav');
            const contentArea = document.getElementById('content-area');
            let currentPhaseIndex = 0;

            function render() {
                // 타임라인 렌더링
                timelineNav.innerHTML = '';
                caseFiles.forEach((file, index) => {
                    const item = document.createElement('div');
                    item.className = `timeline-item flex-1 p-3 md:p-4 rounded-lg shadow-md bg-white border border-slate-200 text-center ${index === currentPhaseIndex ? 'active' : ''}`;
                    item.dataset.index = index;
                    item.innerHTML = `
                        <div class="text-3xl mb-1">${file.icon}</div>
                        <div class="font-bold text-sm md:text-base">${file.title}</div>
                        <div class="timeline-phase text-xs text-slate-500">${file.phase}</div>
                    `;
                    timelineNav.appendChild(item);
                });

                // 콘텐츠 렌더링
                const file = caseFiles[currentPhaseIndex];
                contentArea.innerHTML = '';
                const contentDiv = document.createElement('div');
                contentDiv.className = 'content-fade-in bg-white p-6 md:p-8 rounded-lg shadow-lg border border-slate-200';
                
                let investigationItems = file.content.investigation
                    .map(item => `<li class="flex items-start"><span class="mr-2 text-blue-500">-</span><span>${item}</span></li>`)
                    .join('');

                contentDiv.innerHTML = `
                    <h2 class="text-2xl font-bold mb-4 text-slate-900">${file.icon} ${file.title}</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="font-semibold text-lg text-red-600 mb-2">증상</h3>
                            <p class="text-slate-700">${file.content.symptom}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-yellow-600 mb-2">초기 가설 / 시도</h3>
                            <p class="text-slate-700">${file.content.hypothesis}</p>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-blue-600 mb-2">수사 및 단서 (시행착오 포함)</h3>
                            <ul class="space-y-2 text-slate-700">${investigationItems}</ul>
                        </div>
                        <div>
                            <h3 class="font-semibold text-lg text-green-600 mb-2">결정적 돌파구 / 결론</h3>
                            <p class="text-slate-700 font-medium">${file.content.breakthrough}</p>
                        </div>
                    </div>
                `;
                contentArea.appendChild(contentDiv);
            }
            
            timelineNav.addEventListener('click', (e) => {
                const target = e.target.closest('.timeline-item');
                if (target && target.dataset.index) {
                    currentPhaseIndex = parseInt(target.dataset.index, 10);
                    render();
                }
            });

            // 초기 렌더링
            render();
        });
    </script>

</body>
</html>